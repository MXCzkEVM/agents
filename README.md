## Moonchain Transaction Agents

The Moonchain Transaction Agents libraries are designed for proxying transactions on Moonchain or other chains, allowing users to send contract transactions without paying gas fees.

![](/public/flow.png)

It consists of the following components:

- **Server Agents**: Servers that proxy the sending of transactions, reading the RPC address and private key from the .env file and broadcasting transaction requests to the network.
- **Contracts Utils**: Contracts used for proxying transactions, ensuring and verifying that transactions are sent only by the proxy or the user themselves.

## Server

Use the following command to clone the repository and install dependencies:

```bash
git clone https://github.com/MXCzkEVM/agent.git
cd agent
pnpm install
```

Create a .env file with the following two parameters:

- **NITRO_NETWORK_RPC_URL**: Your RPC address
- **NITRO_PRIVATE_KEY**: The private key address of the proxy

> Please ensure that the proxy's private key address has sufficient balance to cover transaction fees, and keep the private key secure to prevent theft.

Use the following script to start the proxy server:

```bash
pnpm dev
```

The server will provide two endpoints:

- **`/proof`**: Used to generate a verification message for the transaction content that the user will sign. It accepts transaction content in JSON format and returns a transaction message.
- **`/agent`**: Used for sending transactions. It accepts a signed message from the user along with the transaction content and returns transaction information.

Access the local `https://localhost:3000/_swagger` address to view the relevant API documentation and use it to test the proxy server.

## Contracts

The contracts are located in the `contracts` directory of this repository. You can reference them in your contract project using npm.

- **`ProxyForward.sol`**: A contract for proxying transactions, ensuring and verifying that transactions are sent only by the proxy or the user themselves.
- **`ProxyForwardUpgradeable.sol`**: A contract for proxying transactions that supports upgradeable contracts.

```sol
import "@moonchain/agents/contracts/ProxyForward.sol";

contract Counter is ProxyForward {
  constructor(address _agent) ProxyForward(_agent) {}

  uint256 public count;

  function add(address sender, uint256 num) public proxy(sender) {
    count += num;
  }

  function sub(address sender, uint256 num) public proxy(sender) {
    count -= num;
  }
}
```

## Usage

This example uses the `Counter.sol` contract written above and utilizes the Agents Servers to proxy the sending of transactions.

```ts
import { Contract, Wallet, Transaction, JsonRpcProvider } from 'ethers'

// Fix BigInt JSON error
BigInt.prototype.toJSON = function () { return this.toString() }

const provider = new JsonRpcProvider('URL_ADDRESS')
const user = new Wallet('264a...3492', provider)
const counter = new Contract('COUNTER_ADDRESS', [...], user)

// 1. Assemble the transaction
const populateTransaction = await counter.add.populateTransaction(user.address, 10)
const parsedTransaction = counter.interface.parsedTransaction(populateTransaction)

// 2. Get the signed message generated by the proxy server
const { data: message } = await fetch('/proof', {
  body: JSON.stringify({
    from: populateTransaction.from,
    to: populateTransaction.to,
    parsed: parsedTransaction,
  }),
  method: 'POST',
})


/**
 * message
 * 
 * From: ...
 * Contract: ...
 * Call: 0xa9059cbb | add(uint256)
 * Params: 
 *   to: ...
 *   value: 400
 * UNonce: 4673 
 */

// 3. Sign the message with the user's private key
const signedMessage = await user.signMessage(message)

// 4. Send the transaction to the proxy server and get the transaction information
const { data: transaction } = await fetch('/agent', {
  body: JSON.stringify({ 
    from: populateTransaction.from,
    to: populateTransaction.to,
    parsed: parsedTransaction,
    signature: signedMessage,
  }),
  method: 'POST',
})

// 5. Wait for the transaction broadcast to complete
const receipt = await provider.waitForTransaction(transaction.hash)
```

## Limitations

Moonchain Transaction Agents do not support the direct sending of native tokens and are only applicable to contract-related transactions.

If you need to support the sending of ERC20 tokens, please modify the ERC20 contract to allow the proxy contract to perform user approvals.

```sol
import "@moonchain/agents/contracts/ProxyForward.sol";

contract ERC20 is ProxyForward {
  constructor(address _agent) ProxyForward(_agent) {}

  function approve_proxy(address sender, address spender, uint256 amount) public proxy(sender) {
    _approve(sender, spender, amount);
  }
}
```

## Production

Use this repository and run the following commands to compile the server and run the production server:

```bash
pnpm build
pnpm preview
```