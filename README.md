## Moonchain Transaction Agents

Moonchain Transaction Agents is a set of code libraries that can be used for proxy sending on Moonchain or other chains.

It consists of the following components:

- **Server Agents**: Servers for proxy sending that read the RPC address and private key from the .env file and broadcast transaction requests to the network.
- **Contracts Utils**: Contracts for proxy sending that ensure and verify that transactions are sent only by the proxy or the sender themselves.

## Server

Use the following command to clone the repository and install dependencies:

```bash
git clone https://github.com/MXCzkEVM/agent.git
cd agent
pnpm install
```

Create a .env file with the following two parameters:

- **NITRO_NETWORK_RPC_URL**: Your RPC address
- **NITRO_PRIVATE_KEY**: The private key address of the proxy

> Please ensure that the proxy's private key address has sufficient balance to pay for transaction fees. Keep the private key secure to prevent theft.

Use the following script to start the proxy server:

```bash
pnpm dev
```

The server will provide two interfaces:

- **`/proof`**: Used to generate the transaction content that the user will sign, accepts transaction content in JSON format, and returns the transaction message.
- **`/agent`**: An interface for sending transactions, accepts a signed message from the user along with the transaction content, and returns transaction information.

Access the local `https://localhost:3000/_swagger` address to see the relevant interface documentation and use it to test the proxy server.

## Contracts

The contracts are located in the `contracts` directory of this repository, and you can import them into your contract project via npm.

- **`ProxyForward.sol`**: A contract for proxy sending that ensures and verifies that transactions are sent only by the proxy or the sender themselves.
- **`ProxyForwardUpgradeable.sol`**: A contract for proxy sending designed for upgradeable contracts.

```sol
import "@moonchain/agents/contracts/ProxyForward.sol";

contract Counter is ProxyForward {
  constructor(address _agent) ProxyForward(_agent) {}

  uint256 public count;

  function add(address sender, uint256 num) public proxy(sender) {
    count += num;
  }

  function sub(address sender, uint256 num) public proxy(sender) {
    count -= num;
  }
}
```

## Usage

This example uses the contract `Counter.sol` written above and utilizes the Agents Servers to proxy send transactions.

```ts
import { Contract, Wallet, Transaction, JsonRpcProvider } from 'ethers'

const provider = new JsonRpcProvider('URL_ADDRESS')
const user = new Wallet('264a...3492', provider)
const counter = new Contract('COUNTER_ADDRESS', [...], user)

// 1. Assemble transaction JSON
const populateTransaction = await counter.add.populateTransaction(user.address, 10)
const hexlifyTransaction = Transaction.from(populateTransaction).toJSON()

// 2. Get the signature information generated by the proxy server
const { data: signMessage } = await fetch('/proof', {
  body: JSON.stringify(hexlifyTransaction),
  method: 'POST',
})

// 3. Sign the message using the user's private key
const signature = await user.signMessage(signMessage)

// 4. Send the transaction to the proxy server and get transaction information
const { data: transaction } = await fetch('/agent', {
  body: JSON.stringify({ 
    transaction: hexlifyTransaction,
    signature
  }),
  method: 'POST',
})

// 5. Wait for the transaction broadcast to complete
const receipt = await provider.waitForTransaction(transaction.hash)
```

## Limitations

Moonchain Transaction Agents do not support direct sending of native tokens and are only applicable for contract-related transactions.

```ts
import { Contract, Wallet, Transaction, JsonRpcProvider } from 'ethers'

const { data: signMessage } = await fetch('/proof', {
  // The value field is not supported
  body: JSON.stringify({ ..., value: 100 }),
  method: 'POST',
})
```

If you need to support sending ERC20 tokens, please modify the ERC20 contract to allow the proxy contract to perform user approvals.

```sol
import "@moonchain/agents/contracts/ProxyForward.sol";

contract YourERC20Token is ProxyForward {
  constructor(address _agent) ProxyForward(_agent) {}

  function approve_proxy(address sender, address spender, uint256 amount) public proxy(sender) {
    _approve(sender, spender, amount);
  }
}
```

## Production

Use this repository and compile the server with the following commands to run the production server:

```bash
pnpm build
pnpm preview
```